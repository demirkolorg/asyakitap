generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String                  @id @default(uuid())
  email                String                  @unique
  books                Book[]
  userReadingListBooks UserReadingListBook[]
  challengeProgress    UserChallengeProgress[]
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
}

enum BookStatus {
  TO_READ
  READING
  COMPLETED
  DNF
}

// ==========================================
// Yazar Modeli
// ==========================================

model Author {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String?
  bio       String?  @db.Text
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ==========================================
// YayÄ±nevi Modeli
// ==========================================

model Publisher {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String?
  website   String?
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Book {
  id                   String                @id @default(cuid())
  userId               String
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  title                String
  authorId             String?
  author               Author?               @relation(fields: [authorId], references: [id])
  publisherId          String?
  publisher            Publisher?            @relation(fields: [publisherId], references: [id])
  coverUrl             String?
  pageCount            Int?
  isbn                 String?
  publishedDate        String?               // YayÄ±n tarihi (Ã¶rn: "29.10.2025")
  description          String?               @db.Text // Kitap aÃ§Ä±klamasÄ±
  status               BookStatus            @default(TO_READ)
  currentPage          Int                   @default(0)
  tortu                String?               @db.Text // Kitaptan aklÄ±nda kalanlar
  tortuAiComment       String?               @db.Text // AI'Ä±n tortu yorumu
  imza                 String?               @db.Text // YazarÄ±n bu kitaptaki Ã¼slubu/tarzÄ±
  imzaAiComment        String?               @db.Text // AI'Ä±n imza yorumu
  quotes               Quote[]
  readingLogs          ReadingLog[]
  userReadingListBooks UserReadingListBook[]
  challengeBooks       UserChallengeBook[]   // Challenge kitaplarÄ±yla baÄŸlantÄ±
  aiComments           AIComment[]           // AI yorumlarÄ±
  startDate            DateTime?
  endDate              DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([userId])
  @@index([authorId])
  @@index([publisherId])
  @@index([userId, status]) // Status bazlÄ± sorgular iÃ§in (reading, completed, etc.)
  @@index([userId, updatedAt]) // Son gÃ¼ncellenen kitaplar iÃ§in
}

enum ReadingAction {
  STARTED
  FINISHED
  ABANDONED
  RESTARTED
  ADDED_TO_LIST
}

// ==========================================
// AI YorumlarÄ±
// ==========================================

enum AICommentSource {
  TORTU
  IMZA
  STATS  // Ä°statistik analizi
}

model AIComment {
  id          String           @id @default(cuid())
  bookId      String?          // Opsiyonel - STATS iÃ§in null olabilir
  book        Book?            @relation(fields: [bookId], references: [id], onDelete: Cascade)
  userId      String?          // STATS iÃ§in kullanÄ±cÄ± ID'si
  source      AICommentSource  // TORTU, IMZA veya STATS
  userContent String           @db.Text // KullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± orijinal iÃ§erik (STATS iÃ§in istatistik Ã¶zeti)
  aiComment   String           @db.Text // AI'Ä±n yorumu
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([bookId])
  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

model ReadingLog {
  id        String        @id @default(cuid())
  bookId    String
  book      Book          @relation(fields: [bookId], references: [id], onDelete: Cascade)
  action    ReadingAction
  note      String?
  createdAt DateTime      @default(now())

  @@index([bookId])
  @@index([bookId, createdAt]) // SÄ±ralÄ± okuma loglarÄ± iÃ§in
}

model Quote {
  id        String   @id @default(cuid())
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  page      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookId])
  @@index([bookId, createdAt]) // SÄ±ralÄ± alÄ±ntÄ±lar iÃ§in
}

// ==========================================
// Tematik Okuma Listeleri
// ==========================================

model ReadingList {
  id          String             @id @default(cuid())
  slug        String             @unique
  name        String
  description String?            @db.Text
  coverUrl    String?
  sortOrder   Int                @default(0)
  levels      ReadingListLevel[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model ReadingListLevel {
  id            String            @id @default(cuid())
  readingListId String
  readingList   ReadingList       @relation(fields: [readingListId], references: [id], onDelete: Cascade)
  levelNumber   Int
  name          String
  description   String?           @db.Text
  books         ReadingListBook[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([readingListId, levelNumber])
  @@index([readingListId])
}

model ReadingListBook {
  id        String                @id @default(cuid())
  levelId   String
  level     ReadingListLevel      @relation(fields: [levelId], references: [id], onDelete: Cascade)
  title     String
  author    String
  neden     String?               @db.Text
  pageCount Int?
  coverUrl  String?
  sortOrder Int                   @default(0)
  userLinks UserReadingListBook[]
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@index([levelId])
}

model UserReadingListBook {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  readingListBookId String
  readingListBook   ReadingListBook @relation(fields: [readingListBookId], references: [id], onDelete: Cascade)
  bookId            String?
  book              Book?           @relation(fields: [bookId], references: [id], onDelete: SetNull)
  createdAt         DateTime        @default(now())

  @@unique([userId, readingListBookId])
  @@index([userId])
  @@index([readingListBookId])
  @@index([bookId])
}

// ==========================================
// YÄ±llÄ±k Okuma Hedefi (Reading Challenge)
// ==========================================

model ReadingChallenge {
  id          String                 @id @default(cuid())
  year        Int                    @unique
  name        String                 // "2026 Okuma Hedefi"
  description String?                @db.Text
  strategy    String                 @default("1_MAIN_2_BONUS")
  isActive    Boolean                @default(true)
  months      ChallengeMonth[]
  userProgress UserChallengeProgress[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
}

model ChallengeMonth {
  id          String            @id @default(cuid())
  challengeId String
  challenge   ReadingChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  monthNumber Int               // 1-12
  monthName   String            // "Ocak", "Åžubat"...
  theme       String            // "Bilim Kurgu & Macera"
  themeIcon   String?           // "ðŸš€"
  books       ChallengeBook[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([challengeId, monthNumber])
  @@index([challengeId])
}

enum ChallengeBookRole {
  MAIN
  BONUS
}

enum ChallengeBookStatus {
  LOCKED      // Bonus kitaplar baÅŸlangÄ±Ã§ta kilitli
  NOT_STARTED // EriÅŸilebilir ama baÅŸlanmamÄ±ÅŸ
  IN_PROGRESS // Okunuyor
  COMPLETED   // TamamlandÄ±
}

model ChallengeBook {
  id           String              @id @default(cuid())
  monthId      String
  month        ChallengeMonth      @relation(fields: [monthId], references: [id], onDelete: Cascade)
  title        String
  author       String
  role         ChallengeBookRole   // MAIN veya BONUS
  pageCount    Int?
  coverUrl     String?
  reason       String?             @db.Text // Neden bu kitap seÃ§ildi
  sortOrder    Int                 @default(0)
  userProgress UserChallengeBook[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([monthId])
  @@index([monthId, role])
}

// KullanÄ±cÄ±nÄ±n challenge genelindeki durumu
model UserChallengeProgress {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeId  String
  challenge    ReadingChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  joinedAt     DateTime         @default(now())
  books        UserChallengeBook[]

  @@unique([userId, challengeId])
  @@index([userId])
  @@index([challengeId])
}

// KullanÄ±cÄ±nÄ±n her kitap iÃ§in durumu
model UserChallengeBook {
  id              String               @id @default(cuid())
  userProgressId  String
  userProgress    UserChallengeProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)
  challengeBookId String
  challengeBook   ChallengeBook        @relation(fields: [challengeBookId], references: [id], onDelete: Cascade)
  status          ChallengeBookStatus  @default(LOCKED)
  linkedBookId    String?              // KullanÄ±cÄ±nÄ±n kÃ¼tÃ¼phanesindeki kitaba baÄŸlantÄ±
  linkedBook      Book?                @relation(fields: [linkedBookId], references: [id], onDelete: SetNull)
  startedAt       DateTime?
  completedAt     DateTime?
  takeaway        String?              @db.Text // "Bu kitaptan aklÄ±nda kalan tek cÃ¼mle"
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([userProgressId, challengeBookId])
  @@index([userProgressId])
  @@index([challengeBookId])
  @@index([linkedBookId])
  @@index([status])
}
