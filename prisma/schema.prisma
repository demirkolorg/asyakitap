generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String                  @id @default(uuid())
  email             String                  @unique
  books             Book[]
  challengeProgress UserChallengeProgress[]
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
}

enum BookStatus {
  TO_READ
  READING
  COMPLETED
  DNF
}

// ==========================================
// Yazar Modeli
// ==========================================

model Author {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String?
  bio       String?  @db.Text
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

// ==========================================
// YayÄ±nevi Modeli
// ==========================================

model Publisher {
  id        String   @id @default(cuid())
  name      String
  imageUrl  String?
  website   String?
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Book {
  id                   String                @id @default(cuid())
  userId               String
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  title                String
  authorId             String?
  author               Author?               @relation(fields: [authorId], references: [id])
  publisherId          String?
  publisher            Publisher?            @relation(fields: [publisherId], references: [id])
  coverUrl             String?
  pageCount            Int?
  isbn                 String?
  publishedDate        String?               // YayÄ±n tarihi (Ã¶rn: "29.10.2025")
  description          String?               @db.Text // Kitap aÃ§Ä±klamasÄ±
  inLibrary            Boolean               @default(false) // Kitap fiziksel olarak kÃ¼tÃ¼phanede mi?
  status               BookStatus            @default(TO_READ)
  currentPage          Int                   @default(0)
  tortu                String?               @db.Text // Kitaptan aklÄ±nda kalanlar
  tortuAiComment       String?               @db.Text // AI'Ä±n tortu yorumu
  imza                 String?               @db.Text // YazarÄ±n bu kitaptaki Ã¼slubu/tarzÄ±
  imzaAiComment        String?               @db.Text // AI'Ä±n imza yorumu
  mindmapContent       String?               @db.Text // Zihin haritasÄ± (Markdown formatÄ±nda)
  briefing             String?               @db.Text // DetaylÄ± brifing (hazÄ±r dÃ¶kÃ¼man)
  infographicUrl       String?               // AI tarafÄ±ndan Ã¼retilen infografik gÃ¶rsel URL'i
  quotes               Quote[]
  readingLogs          ReadingLog[]
  readingNotes         ReadingNote[]         // Okuma notlarÄ± (okurken alÄ±nan notlar)
  aiComments           AIComment[]           // AI yorumlarÄ±
  readingListBooks     ReadingListBook[]     // Bu kitabÄ±n bulunduÄŸu okuma listeleri
  challengeBooks       ChallengeBook[]       // Bu kitabÄ±n bulunduÄŸu challenge'lar
  rating               BookRating?           // Kitap puanlamasÄ± (1-1 iliÅŸki)
  themes               BookTheme[]           // KitabÄ±n temalarÄ± (AI ile Ã§Ä±karÄ±lan)
  discussionQuestions  DiscussionQuestion[]  // AI tartÄ±ÅŸma sorularÄ±
  experienceReport     ExperienceReport?     // AI okuma deneyimi raporu
  startDate            DateTime?
  endDate              DateTime?
  readingGoalDays      Int?                  // KullanÄ±cÄ±nÄ±n hedeflediÄŸi okuma gÃ¼n sayÄ±sÄ±
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([userId])
  @@index([authorId])
  @@index([publisherId])
  @@index([userId, status]) // Status bazlÄ± sorgular iÃ§in (reading, completed, etc.)
  @@index([userId, inLibrary]) // KÃ¼tÃ¼phanedeki kitaplar iÃ§in
  @@index([userId, updatedAt]) // Son gÃ¼ncellenen kitaplar iÃ§in
}

enum ReadingAction {
  STARTED
  FINISHED
  ABANDONED
  RESTARTED
  ADDED_TO_LIST
}

// ==========================================
// AI YorumlarÄ±
// ==========================================

enum AICommentSource {
  TORTU
  IMZA
  STATS              // Ä°statistik analizi
  EXPERIENCE_REPORT  // Okuma deneyimi raporu
  READING_NOTE       // Okuma notu analizi
}

model AIComment {
  id          String           @id @default(cuid())
  bookId      String?          // Opsiyonel - STATS iÃ§in null olabilir
  book        Book?            @relation(fields: [bookId], references: [id], onDelete: Cascade)
  userId      String?          // STATS iÃ§in kullanÄ±cÄ± ID'si
  source      AICommentSource  // TORTU, IMZA veya STATS
  userContent String           @db.Text // KullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± orijinal iÃ§erik (STATS iÃ§in istatistik Ã¶zeti)
  aiComment   String           @db.Text // AI'Ä±n yorumu
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([bookId])
  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

model ReadingLog {
  id        String        @id @default(cuid())
  bookId    String
  book      Book          @relation(fields: [bookId], references: [id], onDelete: Cascade)
  action    ReadingAction
  note      String?
  createdAt DateTime      @default(now())

  @@index([bookId])
  @@index([bookId, createdAt]) // SÄ±ralÄ± okuma loglarÄ± iÃ§in
}

model Quote {
  id        String   @id @default(cuid())
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  page      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookId])
  @@index([bookId, createdAt]) // SÄ±ralÄ± alÄ±ntÄ±lar iÃ§in
}

// ==========================================
// Okuma NotlarÄ± (Okurken alÄ±nan notlar)
// ==========================================

model ReadingNote {
  id        String   @id @default(cuid())
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  content   String   @db.Text    // Not iÃ§eriÄŸi
  page      Int?                 // Sayfa numarasÄ± (opsiyonel)
  mood      String?              // Ruh hali/emoji (opsiyonel)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookId])
  @@index([bookId, createdAt]) // Kronolojik sÄ±ralama iÃ§in
}

// ==========================================
// Kitap Puanlama Sistemi
// ==========================================

model BookRating {
  id              String   @id @default(cuid())
  bookId          String   @unique // Her kitapta sadece bir puanlama olabilir
  book            Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Ä°Ã§erik & Hikaye (1-10)
  konuFikir       Int      // Konu/Fikir: Ana tema, mesaj veya fikrin Ã¶zgÃ¼nlÃ¼ÄŸÃ¼ ve derinliÄŸi
  akicilik        Int      // AkÄ±cÄ±lÄ±k: Okuma hÄ±zÄ±, sayfa Ã§evirme isteÄŸi
  derinlik        Int      // Derinlik: Konunun iÅŸlenme seviyesi, detay zenginliÄŸi
  etki            Int      // Etki: KitabÄ±n bÄ±raktÄ±ÄŸÄ± iz, dÃ¼ÅŸÃ¼ndÃ¼rme gÃ¼cÃ¼

  // YazarlÄ±k & Ãœslup (1-10)
  dilUslup        Int      // Dil & Ãœslup: YazarÄ±n anlatÄ±m gÃ¼cÃ¼, kelime seÃ§imi
  karakterAnlatim Int      // Karakter/AnlatÄ±m: Karakter derinliÄŸi veya anlatÄ±m tutarlÄ±lÄ±ÄŸÄ±
  ozgunluk        Int      // Ã–zgÃ¼nlÃ¼k: YazarÄ±n kendine has sesi

  // Teknik & Ãœretim (1-10)
  baskiTasarim    Int      // BaskÄ±/TasarÄ±m: Kapak, kaÄŸÄ±t kalitesi, punto, sayfa dÃ¼zeni

  // Genel (1-10)
  tavsiyeEderim   Int      @default(5) // Tavsiye Eder misin?: BaÅŸkalarÄ±na Ã¶nerir misin? (1-10)
  genelPuan       Int      // Genel Puan: TÃ¼m deÄŸerlendirmelerin Ã¶zeti

  // Hesaplanan ortalama (otomatik)
  ortalamaPuan    Float    // 10 kategorinin ortalamasÄ±

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([bookId])
  @@index([ortalamaPuan])
}

// ==========================================
// Tematik Okuma Listeleri
// ==========================================

model ReadingList {
  id          String             @id @default(cuid())
  slug        String             @unique
  name        String
  description String?            @db.Text
  coverUrl    String?
  sortOrder   Int                @default(0)
  levels      ReadingListLevel[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model ReadingListLevel {
  id            String            @id @default(cuid())
  readingListId String
  readingList   ReadingList       @relation(fields: [readingListId], references: [id], onDelete: Cascade)
  levelNumber   Int
  name          String
  description   String?           @db.Text
  coverUrl      String?           // Seviye kapak gÃ¶rseli
  books         ReadingListBook[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([readingListId, levelNumber])
  @@index([readingListId])
}

model ReadingListBook {
  id        String                @id @default(cuid())
  levelId   String
  level     ReadingListLevel      @relation(fields: [levelId], references: [id], onDelete: Cascade)
  bookId    String                // Book tablosuna referans
  book      Book                  @relation(fields: [bookId], references: [id], onDelete: Cascade)
  neden     String?               @db.Text // Bu kitap neden okunmalÄ±?
  sortOrder Int                   @default(0)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  @@unique([levelId, bookId]) // AynÄ± seviyede aynÄ± kitap olamaz
  @@index([levelId])
  @@index([bookId])
}


// ==========================================
// YÄ±llÄ±k Okuma Hedefi (Reading Challenge)
// ==========================================

model ReadingChallenge {
  id          String                 @id @default(cuid())
  year        Int                    @unique
  name        String                 // "2026 Okuma Hedefi"
  description String?                @db.Text
  strategy    String                 @default("1_MAIN_2_BONUS")
  isActive    Boolean                @default(true)
  months      ChallengeMonth[]
  userProgress UserChallengeProgress[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
}

model ChallengeMonth {
  id          String            @id @default(cuid())
  challengeId String
  challenge   ReadingChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  monthNumber Int               // 1-12
  monthName   String            // "Ocak", "Åžubat"...
  theme       String            // "Bilim Kurgu & Macera"
  themeIcon   String?           // "ðŸš€"
  books       ChallengeBook[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([challengeId, monthNumber])
  @@index([challengeId])
}

enum ChallengeBookRole {
  MAIN
  BONUS
}

enum ChallengeBookStatus {
  LOCKED      // Bonus kitaplar baÅŸlangÄ±Ã§ta kilitli
  NOT_STARTED // EriÅŸilebilir ama baÅŸlanmamÄ±ÅŸ
  IN_PROGRESS // Okunuyor
  COMPLETED   // TamamlandÄ±
}

model ChallengeBook {
  id           String              @id @default(cuid())
  monthId      String
  month        ChallengeMonth      @relation(fields: [monthId], references: [id], onDelete: Cascade)
  bookId       String              // Book tablosuna referans
  book         Book                @relation(fields: [bookId], references: [id], onDelete: Cascade)
  role         ChallengeBookRole   // MAIN veya BONUS
  reason       String?             @db.Text // Neden bu kitap seÃ§ildi
  sortOrder    Int                 @default(0)
  userProgress UserChallengeBook[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@unique([monthId, bookId]) // AynÄ± ayda aynÄ± kitap olamaz
  @@index([monthId])
  @@index([monthId, role])
  @@index([bookId])
}

// KullanÄ±cÄ±nÄ±n challenge genelindeki durumu
model UserChallengeProgress {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeId  String
  challenge    ReadingChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  joinedAt     DateTime         @default(now())
  books        UserChallengeBook[]

  @@unique([userId, challengeId])
  @@index([userId])
  @@index([challengeId])
}

// KullanÄ±cÄ±nÄ±n her kitap iÃ§in durumu
model UserChallengeBook {
  id              String               @id @default(cuid())
  userProgressId  String
  userProgress    UserChallengeProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)
  challengeBookId String
  challengeBook   ChallengeBook        @relation(fields: [challengeBookId], references: [id], onDelete: Cascade)
  status          ChallengeBookStatus  @default(LOCKED)
  startedAt       DateTime?
  completedAt     DateTime?
  takeaway        String?              @db.Text // "Bu kitaptan aklÄ±nda kalan tek cÃ¼mle"
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([userProgressId, challengeBookId])
  @@index([userProgressId])
  @@index([challengeBookId])
  @@index([status])
}

// ==========================================
// Kitap TemalarÄ± (AI ile Ã§Ä±karÄ±lan)
// ==========================================

model BookTheme {
  id          String   @id @default(cuid())
  bookId      String
  book        Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  name        String   // Tema adÄ± (Ã¶rn: "AÅŸk", "SavaÅŸ", "Ã–zgÃ¼rlÃ¼k")
  description String?  @db.Text // Tema aÃ§Ä±klamasÄ±
  confidence  Float    @default(0.8) // AI gÃ¼ven skoru (0-1)
  isManual    Boolean  @default(false) // KullanÄ±cÄ± tarafÄ±ndan mÄ± eklendi?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([bookId, name]) // AynÄ± kitapta aynÄ± tema tekrarlanmasÄ±n
  @@index([bookId])
  @@index([name])
}

// ==========================================
// AI TartÄ±ÅŸma SorularÄ±
// ==========================================

enum QuestionType {
  REFLECTION  // YansÄ±ma - kiÅŸisel baÄŸ kurma
  ANALYSIS    // Analiz - yapÄ±, karakterler, semboller
  CONNECTION  // BaÄŸlantÄ± - gÃ¼nÃ¼mÃ¼z, evrensel temalar
  OPINION     // GÃ¶rÃ¼ÅŸ - tartÄ±ÅŸmaya aÃ§Ä±k
}

enum QuestionDifficulty {
  EASY    // Kolay
  MEDIUM  // Orta
  DEEP    // Derin
}

model DiscussionQuestion {
  id          String             @id @default(cuid())
  bookId      String
  book        Book               @relation(fields: [bookId], references: [id], onDelete: Cascade)
  question    String             @db.Text
  type        QuestionType
  difficulty  QuestionDifficulty
  sortOrder   Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([bookId])
}

// ==========================================
// AI Okuma Deneyimi Raporu
// ==========================================

model ExperienceReport {
  id               String   @id @default(cuid())
  bookId           String   @unique // Her kitapta sadece bir rapor
  book             Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  context          String?  @db.Text // AI baÄŸlam Ã¶zeti

  // Rapor bÃ¶lÃ¼mleri (JSON olarak saklanabilir veya ayrÄ± alanlar)
  overallExperience String? @db.Text // Genel okuma deneyimi
  emotionalJourney  String? @db.Text // Duygusal yolculuk
  keyInsights       String? @db.Text // Ã–nemli Ã§Ä±karÄ±mlar
  memorableMoments  String? @db.Text // AkÄ±lda kalan anlar
  personalGrowth    String? @db.Text // KiÅŸisel geliÅŸim
  recommendation    String? @db.Text // Tavsiye notu

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([bookId])
}
